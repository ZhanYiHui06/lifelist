<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的人生完成清单</title>

    <!-- 
      引入 html2canvas 库
      https://cdnjs.com/libraries/html2canvas
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- 基础样式 (用户可见界面) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f7f9fc;
            color: #333;
            margin: 0;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            color: #d9534f;
            margin-bottom: 10px;
        }

        .progress-container {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 20px;
            white-space: nowrap;
        }
        
        #progress-count {
            color: #f0ad4e;
            font-size: 1.5em;
            margin: 0 4px;
        }

        #total-count {
            margin: 0 4px;
        }

        .checklist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        @media (min-width: 640px) {
            .checklist-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
        }

        .checklist-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 8px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 40px; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-wrap: break-word;
            word-break: break-word;
            transition: transform 0.1s ease-out,
                        box-shadow 0.1s ease-out,
                        background-color 0.2s ease,
                        border-color 0.2s ease,
                        color 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .checklist-item:active {
            transform: scale(0.96);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .checklist-item:hover {
            border-color: #aaa;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        .checklist-item.completed {
            background-color: #f0ad4e;
            color: #ffffff;
            border-color: #f0ad4e;
            font-weight: bold;
        }

        .checklist-item.completed:active {
            background-color: #e69a3d;
            transform: scale(0.96);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .button-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .export-button, .reset-button {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s ease-out;
            -webkit-tap-highlight-color: transparent;
        }
        
        .export-button { background-color: #5cb85c; }
        .export-button:hover { background-color: #4cae4c; }
        .export-button:active { transform: scale(0.96); }

        .reset-button { background-color: #d9534f; margin-top: 0; }
        .reset-button:hover { background-color: #c9302c; }
        .reset-button:active { transform: scale(0.96); }


        .export-button:disabled,
        .reset-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: scale(1);
        }


        /* -------------------------------------------
         重大更新: 导出图片专用样式 (9:16 布局)
        -------------------------------------------
        */

        /* 1. 导出容器 (画布)
         - 隐藏在屏幕外
         - 严格的 9:16 比例 (1080x1920)
         - 基础尺寸，将通过 scale: 2 放大
        */
        #export-image-container {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 1080px;  /* 基础宽度 1080p */
            height: 1920px; /* 基础高度 1080p */
            background: #fdfaf6;
            font-family: Arial, sans-serif;
            color: #333;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            padding: 60px 50px; /* 上下 60, 左右 50 */
        }

        /* 2. 导出标题 */
        #export-image-container .export-title {
            font-size: 64px;
            font-weight: bold;
            color: #d9534f;
            text-align: center;
            margin: 20px 0;
        }

        /* 3. 导出进度 */
        #export-image-container .export-progress {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            color: #555;
            margin-bottom: 40px;
        }

        #export-image-container .export-progress-count {
            color: #f0ad4e;
            font-size: 1.2em;
        }

        /* 4. 导出网格 (核心) */
        #export-image-container .export-grid-wrapper {
            flex: 1; /* 占据所有剩余空间 */
            overflow: hidden; /* 确保内容不会溢出 1920 的高度 */
        }
        
        #export-image-container .export-grid {
            display: grid;
            /* 6 列布局, 确保 158 个项目能放下 */
            grid-template-columns: repeat(6, 1fr); 
            gap: 10px; /* 紧凑的间隙 */
        }

        /* 5. 导出的项目 (所有) */
        #export-image-container .export-item {
            /* 默认: 未选中样式 */
            background-color: #f3f4f6; /* 浅灰色底 */
            color: #374151; /* 深灰色字 */
            border-radius: 6px;
            padding: 8px 4px;
            font-size: 13px; /* 更小的字体以适应布局 */
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-wrap: break-word;
            word-break: break-word;
            min-height: 40px; /* 最小高度 */
            transition: all 0.2s; /* (为了平滑，虽然截图时用不到) */
        }

        /* 6. 导出的项目 (已选中) */
        #export-image-container .export-item.completed {
            background-color: #f0ad4e; /* 橙色底 */
            color: #ffffff; /* 白色字 */
            font-weight: 600; /* 稍粗 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }


        /* 7. 导出页脚 */
        #export-image-container .export-footer {
            font-size: 20px;
            color: #aaa;
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

    </style>
</head>
<body>

    <div class="container">
        <div id="capture-area">
            <h1>人生完成清单</h1>
            
            <div class="progress-container">
                <span id="progress-count">0</span> / <span id="total-count">0</span>
            </div>

            <div class="checklist-grid" id="checklist">
                <!-- JavaScript 将在此处自动填充按钮 -->
            </div>
        </div>

        <div class="button-controls">
            <button class="export-button" id="export-btn">导出为图片</button>
            <button class="reset-button" id="reset-btn">重置进度</button>
        </div>
    </div>

    <script>
        // --- 1. 你的清单项目 ---
        const items = [
            "送礼物", "被送礼物", "暗恋", "明恋", "失恋", "表白", "被表白", "留长发", "剪短发", 
            "染发", "漂发", "烫发", "化妆", "做美甲", "放下一个人", "有过遗憾", "爱而不得", 
            "双向奔赴", "当海王", "拒绝他人表白", "表白被拒", "被渣", "犯过傻", "装糊涂", 
            "犯校规", "迟到", "旷课", "上课睡觉", "打架被叫家长", "去酒吧", "和朋友去KTV", 
            "断片", "失眠", "睡一天", "吵架", "绝交", "晚上一个人哭", "献血", "住院", "做手术", 
            "晕倒", "会做饭", "做一桌菜", "做饭给家人", "做甜品给喜欢的人", "有超过10年的好朋友", 
            "有个无条件可信任的朋友", "买花", "被送花", "给自己买礼物", "通宵补作业", 
            "一个人散步", "夜跑", "深夜放毒", "向陌生人吐露心声", "一个人出去吃饭", "一个人看电影", 
            "摄影", "一个人去酒吧", "一个人过生日", "一个人逛超市", "一个人去图书馆", "一个人看病", 
            "一个人去唱歌", "社死过", "一个人出门逛", "一个人在外难过", "给自己写信", "出国", 
            "一个人旅游", "跟朋友旅游", "拥有要好的异性朋友", "谈恋爱", "考试不及格", "考试第一名", 
            "当班干部", "竞选学生会", "上电视", "上报纸", "登台演出", "主持节目", "演讲", "野性消费", 
            "被雪糕刺客刺伤过", "被老师点名表扬", "被老师点名批评", "全校表扬", "被背叛", "被伤害", 
            "被坚定选择", "获奖", "学一门外语", "写论文", "写书", "写诗", "写日记", "写剧本", 
            "写歌", "拍影片", "参加比赛", "拍写真", "买相机", "会一种乐器", "有过超过5年的兴趣爱好", 
            "参加志愿活动", "自己一个人住宾馆", "看鬼片", "去密室", "去鬼屋", "去游乐场", 
            "去看现场演唱会", "去音乐节", "偶遇明星", "去签售会", "在图书馆待一天", "兼职", 
            "打工", "看画展", "捐款", "道歉", "释怀", "失望", "淋雨", "种花", "养宠物", "泡温泉", 
            "跳伞", "坐过山车", "蹦极", "骑马", "骑卡丁车", "攀岩", "游泳", "滑冰", "滑雪", "潜水", 
            "冲浪", "旱冰", "滑板", "野炊", "登山", "看雪", "看海", "看日出", "看日落", "拿驾照", 
            "自驾游", "给父母买衣服", "当伴娘/郎", "摆地摊", "和同学打水仗", "社团活动", "组建社团", 
            "写信", "独自坐飞机", "拼拼图", "办生日会", "健身", "买名牌", "开网店", "练字", 
            "沉迷游戏", "拍毕业照", "面试成功", "放孔明灯", "逛小吃街", "和网友见面", "发表成果", 
            "买唱片", "异地恋", "异国恋", "认识不同国籍的人", "创业", "看极光", "进大公司工作", 
            "做未来规划", "独居", "一个人租房", "转学", "被骗", "撒谎", "改掉一个坏习惯", 
            "加入校队", "坐摩天轮", "在朋友家过夜", "擅长一项运动", "谈过一场刻骨铭心的恋爱"
        ];
        
        // --- 2. 变量定义 ---
        const grid = document.getElementById('checklist');
        const progressCountEl = document.getElementById('progress-count');
        const totalCountEl = document.getElementById('total-count');
        const resetBtn = document.getElementById('reset-btn');
        const exportBtn = document.getElementById('export-btn');
        const storageKey = 'lifeChecklistState'; 

        // --- 3. 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            let completedItems = loadState();

            items.forEach(itemText => {
                const button = document.createElement('button');
                button.className = 'checklist-item';
                button.textContent = itemText;
                
                if (completedItems.includes(itemText)) {
                    button.classList.add('completed');
                }
                
                grid.appendChild(button);
            });

            totalCountEl.textContent = items.length;
            updateProgress();
        });

        // --- 4. 事件监听 ---

        grid.addEventListener('click', (e) => {
            if (e.target.classList.contains('checklist-item')) {
                handleItemClick(e.target);
            }
        });

        resetBtn.addEventListener('click', () => {
            console.log("重置按钮被点击");
            if (window.self === window.top) {
                if (confirm('你确定要重置所有进度吗？这将清除所有高亮记录。')) {
                    resetProgress();
                }
            } else {
                console.log("在iframe中，跳过confirm，直接重置");
                resetProgress(); 
            }
        });

        // --- (重大更新) 导出按钮点击 ---
        exportBtn.addEventListener('click', () => {
            
            // 1. 获取所有已完成的项目
            const completedButtons = document.querySelectorAll('.checklist-item.completed');
            const completedTexts = Array.from(completedButtons).map(btn => btn.textContent);
            const progressText = `${completedButtons.length} / ${items.length}`;
            // (新增) 创建一个 Set, 方便快速查找
            const completedSet = new Set(completedTexts);

            // 2. 设置加载状态
            exportBtn.disabled = true;
            resetBtn.disabled = true;
            exportBtn.textContent = '正在生成中...';

            // 3. 创建屏幕外容器
            const exportContainer = document.createElement('div');
            exportContainer.id = 'export-image-container';

            // 4. (重大修改) 动态生成 *所有* 项目的 HTML
            let itemsHTML = '';
            items.forEach(text => {
                const cleanText = text.replace(/`/g, '\\`').replace(/\$/g, '\\$');
                // 检查这个项目是否在已完成的 Set 中
                const isCompleted = completedSet.has(text);
                const completedClass = isCompleted ? 'completed' : '';
                
                itemsHTML += `<div class="export-item ${completedClass}">${cleanText}</div>`;
            });

            // 5. 填充容器的 HTML
            exportContainer.innerHTML = `
                <div class="export-title">人生完成清单</div>
                <div class="export-progress">
                    已完成: <span class="export-progress-count">${progressText}</span>
                </div>
                <div class="export-grid-wrapper">
                    <div class="export-grid">
                        ${itemsHTML}
                    </div>
                </div>
                <div class="export-footer">My Life Checklist</div>
            `;

            // 6. 将容器添加到 DOM 中 (必需)
            document.body.appendChild(exportContainer);

            // 7. (重大修改) 调用 html2canvas 并提高分辨率
            html2canvas(exportContainer, {
                useCORS: true,
                backgroundColor: null, 
                // 提高分辨率:
                // 基础 1080p * 2 = 2160x3840
                scale: 2
            }).then(canvas => {
                // 8. 创建下载链接
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'my-life-checklist-HD.png';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link); 

            }).catch(err => {
                console.error('图片生成失败:', err);
            }).finally(() => {
                // 9. (重要) 无论成功与否，都移除隐藏容器并恢复按钮
                document.body.removeChild(exportContainer);
                exportBtn.disabled = false;
                resetBtn.disabled = false;
                exportBtn.textContent = '导出为图片';
            });
        });


        // --- 5. 核心功能函数 ---
        function handleItemClick(targetElement) {
            targetElement.classList.toggle('completed');
            updateProgress();
        }

        function resetProgress() {
            document.querySelectorAll('.checklist-item.completed').forEach(btn => {
                btn.classList.remove('completed');
            });
            updateProgress();
        }

        // --- 6. 辅助函数 (本地存储) ---
        function updateProgress() {
            const completedButtons = document.querySelectorAll('.checklist-item.completed');
            progressCountEl.textContent = completedButtons.length;
            saveState(completedButtons);
        }

        function saveState(completedButtons) {
            try {
                const completedItems = Array.from(completedButtons).map(btn => btn.textContent);
                localStorage.setItem(storageKey, JSON.stringify(completedItems));
            } catch (error) {
                console.warn("无法保存进度到本地存储:", error);
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem(storageKey);
                return savedState ? JSON.parse(savedState) : [];
            } catch (error) {
                console.warn("无法从本地存储加载进度:", error);
                return [];
            }
        }

    </script>
</body>
</html>


